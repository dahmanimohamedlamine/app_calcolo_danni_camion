<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Data Filters for Truck Dataset</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        /* Dark theme styling */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; font-family: Arial, sans-serif; background-color: #1e1e2e; color: #ffffff; }
        .container { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        .filters { display: flex; flex-direction: column; flex-basis: 40%; padding: 20px; background-color: #2b2b3d; border-right: 1px solid #444; overflow-y: auto; max-width: 600px; }
        .filters h2 { font-size: 22px; margin-bottom: 15px; color: #9a9abe; }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .filters label { font-weight: bold; margin-top: 10px; display: block; color: #9a9abe; }
        .filters select, .filters input[type="file"], .filters input[type="date"], .filters input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #555; border-radius: 4px; background-color: #3c3c51; color: #ffffff; }
        .stats { display: flex; justify-content: space-between; margin-top: 20px; padding: 10px; background-color: #3c3c51; border-radius: 4px; font-size: 18px; color: #ffffff; }
        .stats .stat { flex: 1; text-align: center; }
        .table-container { flex: 2; padding: 20px; overflow: auto; background-color: #1e1e2e; }
        table { width: 100%; border-collapse: collapse; color: #ffffff; }
        th, td { padding: 8px; text-align: left; border: 1px solid #444; white-space: nowrap; }
        th { background-color: #3c3c51; font-weight: bold; color: #9a9abe; }
        .pagination { display: flex; justify-content: space-between; margin-top: 10px; color: #9a9abe; }
        .pagination button { background-color: #3c3c51; color: #ffffff; padding: 5px 15px; border: 1px solid #555; border-radius: 4px; cursor: pointer; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="filters">
            <h2>Filtri</h2>
            <label for="fileUpload">Carica il file:</label>
            <input type="file" id="fileUpload" accept=".xlsx">
            <div class="filter-grid">
                <div>
                    <label for="causa">Causa:</label>
                    <select id="causa"></select>
                </div>
                <div>
                    <label for="marca">Marca:</label>
                    <select id="marca" multiple></select>
                </div>
                <div>
                    <label for="prezzo">Prezzo:</label>
                    <select id="prezzo"></select>
                </div>
                <div>
                    <label for="condizione">Condizione:</label>
                    <select id="condizione" multiple></select>
                </div>
                <div>
                    <label for="acquisto">Tipologia Acquisto:</label>
                    <select id="acquisto" multiple></select>
                </div>
                <div>
                    <label for="statoAttuale">Stato Attuale dei Camion:</label>
                    <select id="statoAttuale" multiple></select>
                </div>
                <div>
                    <label for="dataFineRivalutazione">Data Fine Rivalutazione:</label>
                    <input type="date" id="dataFineRivalutazione" value="2024-07-31">
                </div>
            </div>
            <div class="stats">
                <div class="stat">
                    <h3>Fatturato</h3>
                    <div id="fatturato">€0,00</div>
                    <input type="number" id="sovrapprezzoCartello" placeholder="Sovrapprezzo Percentuale (Periodo Cartello)" value="32.6">
                    <input type="number" id="sovrapprezzoLingering" placeholder="Sovrapprezzo Percentuale (Periodo Lingering)" value="17.6">
                </div>
                <div class="stat">
                    <h3>Conteggio dei Camion</h3>
                    <div id="conteggio">0</div>
                    <div id="dannoCartello">Danno Sovrapprezzo (Periodo Cartello): €0,00</div>
                    <div id="dannoLingering">Danno Sovrapprezzo (Periodo Lingering): €0,00</div>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div class="pagination">
                <button id="prevPage" disabled>Previous</button>
                <span id="pageIndicator">Page 1</span>
                <button id="nextPage" disabled>Next</button>
            </div>
        </div>
    </div>

    <script>
        let data = {}; 
        let currentData = []; 
        let filteredData = []; 
        let currentPage = 1; 
        const rowsPerPage = 15; 

        document.getElementById('fileUpload').addEventListener('change', function(event) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const dataArray = new Uint8Array(event.target.result);
                const workbook = XLSX.read(dataArray, { type: 'array' });
                data = workbook.SheetNames.reduce((acc, sheetName) => {
                    acc[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: '' });
                    return acc;
                }, {});
                
                populateCausaDropdown(workbook.SheetNames);
                loadSheetData(workbook.SheetNames[0]); 
            };
            reader.readAsArrayBuffer(event.target.files[0]);
        });

        function populateCausaDropdown(sheetNames) {
            const causaSelect = document.getElementById('causa');
            causaSelect.innerHTML = '';
            sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                causaSelect.appendChild(option);
            });
            causaSelect.addEventListener('change', function() {
                loadSheetData(this.value); 
            });
        }

        function loadSheetData(sheetName) {
            currentData = data[sheetName];

            currentData = currentData.map(row => ({
                ...row,
                revendita: row.datavendita ? 'VENDUTI' : 'NO'
            }));

            transformDateColumns(currentData);
            expandTable(); // Automatically expand the table
            populateFilters(currentData); // Populate filters based on expanded data
            applyFilters(); // Display data with default filters
        }

        function transformDateColumns(data) {
            data.forEach(row => {
                for (const key in row) {
                    if (/data|date|mese/i.test(key) && row[key]) {
                        row[key] = formatExcelDate(row[key]);
                    }
                }
            });
        }

        function formatExcelDate(value) {
            if (typeof value === 'number') {
                const date = new Date((value - 25569) * 86400 * 1000);
                return moment(date).format("DD/MM/YYYY");
            } else if (moment(value, ["DD/MM/YYYY", "YYYY-MM-DD", "MM/DD/YYYY"], true).isValid()) {
                return moment(value).format("DD/MM/YYYY");
            }
            return value;
        }

        function populateFilters(data) {
            populateDropdown('marca', getUniqueValues(data, 'marca'));
            populateDropdown('condizione', getUniqueValues(data, 'nuovousato'));
            populateDropdown('acquisto', getUniqueValues(data, 'acquistoleasing'));
            populateDropdown('statoAttuale', getUniqueValues(data, 'revendita'));
            const prezzoColumns = Object.keys(data[0]).filter(col => col.toLowerCase().includes('price') || col.toLowerCase().includes('prezzo'));
            populateDropdown('prezzo', prezzoColumns, 'prezzo_netto');
        }

        function getUniqueValues(data, key) {
            return [...new Set(data.map(item => item[key]))];
        }

        function populateDropdown(elementId, values, defaultValue = null) {
            const select = document.getElementById(elementId);
            select.innerHTML = '';
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
            if (defaultValue) select.value = defaultValue;
            select.addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const selectedMarca = getSelectedValues('marca');
            const selectedCondizione = getSelectedValues('condizione');
            const selectedAcquisto = getSelectedValues('acquisto');
            const selectedStatoAttuale = getSelectedValues('statoAttuale');
            const selectedPrezzo = document.getElementById('prezzo').value;

            filteredData = currentData.map(item => {
                let row = { ...item };
                row['Prezzo Netto'] = selectedPrezzo && row[selectedPrezzo] ? row[selectedPrezzo] : '';
                return row;
            }).filter(item => {
                return (selectedMarca.length === 0 || selectedMarca.includes(item.marca)) &&
                       (selectedCondizione.length === 0 || selectedCondizione.includes(item.nuovousato)) &&
                       (selectedAcquisto.length === 0 || selectedAcquisto.includes(item.acquistoleasing)) &&
                       (selectedStatoAttuale.length === 0 || selectedStatoAttuale.includes(item.revendita)) &&
                       (selectedPrezzo === '' || item[selectedPrezzo] != null);
            });

            displayData();
            calculateFatturatoAndConteggio(selectedPrezzo);
        }

        function calculateFatturatoAndConteggio(prezzoColumn) {
            if (!prezzoColumn) {
                document.getElementById('fatturato').textContent = '€0,00';
                document.getElementById('conteggio').textContent = '0';
                return;
            }

            const uniqueVehicles = {};
            let fatturato = 0;

            filteredData.forEach(row => {
                const uniqueKey = `${row.impresa}-${row.targa}-${row.nuovousato}`;
                if (!uniqueVehicles[uniqueKey]) {
                    uniqueVehicles[uniqueKey] = row;
                    const prezzoValue = parseFloat(row[prezzoColumn]) || 0;
                    fatturato += prezzoValue;
                }
            });

            document.getElementById('fatturato').textContent = `€${fatturato.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('conteggio').textContent = Object.keys(uniqueVehicles).length;
        }

        function getSelectedValues(elementId) {
            const select = document.getElementById(elementId);
            return Array.from(select.selectedOptions).map(option => option.value);
        }

        function displayData() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            if (filteredData.length === 0) return;

            Object.keys(filteredData[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                tableHeader.appendChild(th);
            });

            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const pageIndicator = document.getElementById('pageIndicator');
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;

            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;
            const pageData = filteredData.slice(startIdx, endIdx);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayData();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayData();
            }
        });

        function expandTable() {
            let expandedData = [];

            currentData.forEach(row => {
                const startDate = moment(row.mese_acquisto, "MM/YYYY");
                const endDate = moment(document.getElementById('dataFineRivalutazione').value, "YYYY-MM-DD");
                let firstMonth = true;

                if (startDate.isValid() && endDate.isValid() && startDate.isBefore(endDate)) {
                    let currentDate = startDate.clone();
                    while (currentDate.isSameOrBefore(endDate, 'month')) {
                        let expandedRow = { ...row };
                        expandedRow.mese = currentDate.format("MM/YYYY");

                        if (row.acquistoleasing !== "LEASING" && !firstMonth) {
                            for (const key in expandedRow) {
                                if (key.toLowerCase().includes("prezzo") || key.toLowerCase().includes("price")) {
                                    expandedRow[key] = ""; // Clear price for non-leasing contracts after the first month
                                }
                            }
                        }
                        
                        expandedData.push(expandedRow);
                        currentDate.add(1, 'month');
                        firstMonth = false; // Set firstMonth to false after the first iteration
                    }
                } else {
                    expandedData.push(row);
                }
            });

            currentData = expandedData; // Set expanded data as the main data
        }
    </script>
</body>
</html>